name: ðŸš€ CI/CD Pandora Backend

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    script: |
      set -e
      cd /home/ubuntu/pandora-backend

      echo "â†’ Atualizando cÃ³digo"
      git fetch origin main
      git reset --hard origin/main

      echo "â†’ Gerando .env temporÃ¡rio"
      cat <<EOF > .env
      POSTGRES_USER=$POSTGRES_USER
      POSTGRES_PASSWORD=$POSTGRES_PASSWORD
      POSTGRES_DB=$POSTGRES_DB
      DATABASE_HOST=$DATABASE_HOST
      DATABASE_PORT=$DATABASE_PORT
      REDIS_HOST=$REDIS_HOST
      REDIS_PORT=$REDIS_PORT
      DEBUG=$DEBUG
      SECRET_KEY=$SECRET_KEY
      ALLOWED_HOSTS=$ALLOWED_HOSTS
      EOF

      echo "â†’ Buildando imagem no servidor"
      docker compose --env-file .env -f docker-compose.prod.yml build

      echo "â†’ Subindo containers"
      docker compose --env-file .env -f docker-compose.prod.yml up -d
      rm .env
      echo "âœ… Deploy concluÃ­do!"
