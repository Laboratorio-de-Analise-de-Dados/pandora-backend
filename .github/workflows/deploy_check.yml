name: âœ… Post-Deploy Healthcheck

on:
  workflow_run:
    workflows: ["ğŸš€ CI/CD Pandora Backend"]
    types:
      - completed

jobs:
  healthcheck:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Healthcheck via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            cd /home/ubuntu/pandora-backend

            echo "ğŸ” Verificando containers..."
            docker compose -f docker-compose.prod.yml ps || { echo "âŒ Containers nÃ£o estÃ£o UP"; exit 1; }

            echo "ğŸŒ Testando resposta HTTPS..."
            curl -vkI https://api.project-pandora.com.br || { echo "âŒ HTTPS nÃ£o respondeu"; exit 1; }

            echo "ğŸ” Validando certificado SSL..."
            openssl s_client -connect api.project-pandora.com.br:443 -servername api.project-pandora.com.br < /dev/null | grep "issuer" || { echo "âŒ Certificado invÃ¡lido"; exit 1; }

            echo "âœ… Healthcheck concluÃ­do!"

      - name: Rollback (derrubar containers se falhar)
        if: failure()
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "âš ï¸ Healthcheck falhou. Derrubando containers..."
            cd /home/ubuntu/pandora-backend
            docker compose -f docker-compose.prod.yml down

      - name: Cleanup (remover pasta clonada sempre)
        if: always()
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "ğŸ§¹ Removendo pasta clonada..."
            rm -rf /home/ubuntu/pandora-backend
